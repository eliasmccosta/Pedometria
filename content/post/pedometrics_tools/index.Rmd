---
date: "2020-06-02"
diagram: true
image:
  caption: 'Image credit: [**Elias**](https://www.instagram.com/eliasmendescosta/)'
  focal_point: ""
  placement: 3
math: true
title: Ferramenta pedometricas
subtitle: 'Ferramenta pedometricas para an√°lises de pedologia quantitativa'
summary: ''
bibliography: [references.bib]
link-citations: true 
csl: [geoderma-regional.csl]
authors:
- admin
categories:
  - R
  - Programa√ß√£o
tags:
  - MDS
  - Pedometria
nocite: | 
  @R-bookdown
---

```{r, eval=FALSE, echo=FALSE}
rmarkdown::render('index.Rmd', encoding = 'UTF-8'")
```

# Introdu√ß√£o
Nesse tutorial ser√£o abordados atrav√©s do Algoritmos para Pedologia Quantitativa (AQP em ingl√™s) e pacotes auxiliares uma cole√ß√£o de c√≥digos, ideias, e plotes usando o software R [@2019]. Toda a teoria por tr√°s de grande parte do c√≥digo pode ser encontrada no artigo [*Algorithms for quantitative pedology: A toolkit for soil scientists*](https://www.sciencedirect.com/science/article/pii/S009830041200369X?via%3Dihub) [@Beaudette2013]. Al√©m disso artigos disso alguns exemplos de aplica√ß√µes das ferramentas podem se encontrados em @Pinheiro2016 e @Pinheiro2018. Para fins did√°ticos o tutorial foi dividido em tr√™s partes e os pacotes usados ser√£o *soilDB*, que contem uma base de dados de solos para an√°lises pedom√©tricas, *AQP* que contem as principais ferramentas de pedologia quantitativa usadas no tutorial, *sharpshootR* que contem uma coel√ß√£o de fun√ß√µes que d√£o suporte ao levantamento e explora√ß√£o de dados de solos, *SP* um pacote que fornece classes e m√©todos para dados espaciais: pontos, linhas, pol√≠gonos e grades, *Hmisc* que cont√©m muitas fun√ß√µes √∫teis para an√°lise de dados, gr√°ficos de alto n√≠vel, opera√ß√µes utilit√°rias, fun√ß√µes para calcular o tamanho de amostras, importar e manipular conjuntos de dados, imputar valores ausentes, cria√ß√£o avan√ßada de tabelas, an√°lise de cluster entre outras fun√ß√µes, *lattice* que √© um sistema de visualiza√ß√£o de dados de alto n√≠vel, poderoso e elegante, com √™nfase em dados multivariados, *MASS* com fun√ß√µes e conjuntos de dados para apoiar Venables e Ripley, **Modern Applied Statistics with S** e *plyr* que contem um conjunto de ferramentas que resolve problemas tais como: Divis√£o, aplica√ß√£o e combina√ß√£o de dados. 

## Base de dados dos exerc√≠cios
Todos os dados usados nos exerc√≠cios ou s√£o do pacote *AQP* ou s√£o do pacote *soilDB*. Muitas das informa√ß√µes contidas nesse nesse tutorial foram extra√≠das do [projeto do AQP](http://ncss-tech.github.io/AQP/) 

```{r, warning=FALSE, message=FALSE}
# Carregando os pacotes no R
library(soilDB) 
library(aqp)  
library(sharpshootR) 
library(sp) 
library(Hmisc)
library(lattice)
library(MASS)
library(plyr)
```
# Parte I
Na parte I ser√£o abordadas caracter√≠sticas das fun√ß√µes b√°sicas do *AQP*, conceito de cole√ß√£o de perfis de solos, **SoilProfileCollection**, e verifica√ß√£o da estrutura de dados na cole√ß√£o, al√©m de alguns plotes b√°sicos.
A classe **SoilProfileCollection** foi projetada para simplificar o processo de trabalhar com a cole√ß√£o de dados associados aos perfis de solo: dados em n√≠vel de local (site), dados em n√≠vel de horizonte, dados espaciais, dados de horizontes de diagn√≥sticos, metadados, etc. Os exemplos listados abaixo devem ser copiados/colados deste documento e executados de forma interativa em R. Lembrando que antes de execultar voc√™ deve instalar e carregar todas as bibliot√©cas (pacotes) mencionados. 

## Cria√ß√£o de Objetos
Os objetos **SoilProfileCollection** geralmente s√£o criados pela atrav√©s de objetos *data.frame* (tabelas retangulares de dados) que cont√™m pelo menos tr√™s colunas essenciais:
- Uma coluna de identifica√ß√£o que identifica exclusivamente grupos de horizontes (por exemplo, *pedons*)
- Limites superiores do horizonte
- Limites inferiores do horizonte
O *data.frame* deve ser pr√©-classificado de acordo com o ID do perfil e o limite superior do horizonte. A nota√ß√£o de f√≥rmula √© usada para definir as colunas usadas para promover um objeto *data.frame*.
```{r, warning=FALSE, message=FALSE}
# Carregando dados de solos
# upgrade para SoilProfileCollection
# 'id' √© o nome da coluna que cont√©m o ID do perfil
# 'top' √© o nome da coluna que cont√©m os limites superiores do horizonte
# 'bottom' √© o nome da coluna que cont√©m os limites inferiores do horizonte
data(sp1) # Conjunto de dados sp1 do pacote AQP (data.frame)
aqp::depths(sp1) <- id ~ top + bottom 
aqp::site(sp1) <- ~ group 
```

## Acessando, configurando e substituindo dados
As fun√ß√µes de acesar s√£o usadas para extrair componentes espec√≠ficos dos objetos **SoilProfileCollection**.
```{r, warning=FALSE, message=FALSE}
# M√©todos para inpens√£o dos objetos
idname (sp1) # auto-explicativo
horizonDepths(sp1) # auto-explicativo
depth_units(sp1) # defaults 'cm'
metadata(sp1) # 
profile_id(sp1) # vector com IDs dos perfis
horizonNames(sp1) # coluna com osnomes dos dados dos horizontes
siteNames(sp1) # coluna com os nomes do dados dos locais (site data)
length(sp1) # n√∫mero de perfis na cole√ß√£o
nrow(sp1) # n√∫mero de horizontes na cole√ß√£o
names(sp1) # nomes de colunas dos dados do site e do horizonte, concatenados em um √∫nico vetor
min(sp1) # profundidade de perfil mais raso da cole√ß√£o
max(sp1) # profundidade de perfil mais profundo da cole√ß√£o
```

## Dados do horizonte e do site (local)
Normalmente, os dados do horizonte e do site s√£o os componentes mais importantes dos objetos SoilProfileCollection. Ambos s√£o armazenados internamente como objetos data.frame; com uma ou mais linhas (por ID do perfil) na tabela do horizonte e uma linha (por ID do perfil) na tabela do site. As colunas de qualquer tabela podem ser acessadas com a nota√ß√£o *$*. Novos dados podem ser atribu√≠dos a qualquer tabela da mesma maneira, desde que o comprimento dos novos dados seja:
- Mesmo tamanho que o n√∫mero de perfis na cole√ß√£o (o destino √© a tabela de sites).
- Mesmo comprimento que o n√∫mero de horizontes na cole√ß√£o (o destino √© a tabela do horizonte). 

## Plotando **SoilProfileCollection**
O m√©todo *plot()* para objetos **SoilProfileCollection** gera esbo√ßos de perfis na cole√ß√£o com base nos limites dos horizontes, alinhados verticalmente a uma sequ√™ncia inteira de 1 ao n√∫mero de perfis. Os nomes dos horizontes s√£o extra√≠dos automaticamente de um nome de atributo no n√≠vel do horizonte (se presente) ou por meio de um atributo alternativo fornecido como argumento: *name = 'nomedacoula'*. As cores do horizonte s√£o geradas automaticamente a partir do atributo no n√≠vel do horizonte *soil_color*, ou qualquer outro atributo da descri√ß√£o de cor compat√≠vel com R, fornecido como argumento: *color = 'nomedacoula'*. Essa fun√ß√£o √© altamente personaliz√°vel; portanto, √© prudente consultar a ajuda *(plotSPC)* de tempos em tempos. As cores do solo na nota√ß√£o Munsell podem ser convertidas em cores compat√≠veis com R via *munsell2rgb()*.

```{r, warning=FALSE, message=FALSE}
data(sp4) # Conjunto de dados sp4 do pacote AQP (data.frame)
aqp::depths(sp4) <- id ~ top + bottom 
# Atribui√ß√£o de novos dados a atributos existentes ou novos
sp4$elevation <- rnorm(n=length(sp4), mean=1000, sd=150) # no n√≠vel do site, com base no comprimento dos dados atribu√≠dos
sp4$thickness <- sp4$bottom - sp4$top # n√≠vel do horizonte
# Extra√ß√£o de atributos espec√≠ficos por nome
sp4$clay # Vetor de conte√∫do de argila (dados do horizonte)
```

Os dados do horizonte e do local (site) tamb√©m podem ser modificados por extra√ß√£o para um data.frame, seguidos pela substitui√ß√£o (dados do horizonte) ou jun√ß√£o (dados do site). Observe que, embora essa abordagem ofere√ßa a maior flexibilidade, ela tamb√©m √© a mais perigosa - a substitui√ß√£o dos dados do horizonte por novos dados que n√£o est√£o exatamente de acordo com a classifica√ß√£o original pode corromper seu **SoilProfileCollection**.
```{r, warning=FALSE, message=FALSE}
# extrair dados os horizontes para o data.frame
h <- horizons(sp4)
# Adicionar uma nova coluna e salvar de volta no objeto
h$random.numbers <- rnorm(n=nrow(h), mean=0, sd=1)
# repor dados originais dos horizontes com vers√£o modificada
#!a ordem das linhas n√£o deve ser alterada!
horizons(sp4) <- h
# extrair dados do site para o data.frame
s <- site(sp4)
# Adicionar um grupo para o site fake
s$group <- factor(rep(c('A', 'B'), length.out=nrow(s)))
# junte novos dados do site com dados anteriores: os dados antigos n√£o s√£o substitu√≠dos
site(sp4) <- s
# Verificar
sp4
```

```{r, warning=FALSE, message=FALSE}
# Fazendo um plot simples
plot(sp4, name='name')
# title, note line argument:
title('Perfis de Solo', line=1, cex.main=0.75)
# profiles are centered at integers, from 1 to length(obj)
axis(1, line=0, at=1:15, cex.axis=0.75, font=4, col='blue', col.axis='blue', lwd=2)
mtext('Perfis', side=1, line=2, font=4, col='blue')
# y-axis is based on profile depths
axis(2, line=-1, at=pretty(1:max(sp4)), cex.axis=0.75, font=4, las=1, col='blue', col.axis='blue', lwd=2)
mtext('Profundidade', side=2, line=1, font=4, col='blue')

# plot com separa√ß√£o de grupos
aqp::groupedProfilePlot(sp4, groups='group', max.depth=240, group.name.offset = -5, id.style='side')
# Esbo√ßos Tem√°ticos

sp4$clay # 
par(mar=c(1,1,3,1)) # tighter figure margins
plot(sp4, name='name', color='clay',cex.names=0.5,cex.id=0.5, id.style='top',col.legend.cex=1,family="serif", col.label='Argila', )

sp4$Ca # 
par(mar=c(1,1,3,1)) # tighter figure margins
plot(sp4, name='name', color='Ca',cex.names=0.5,cex.id=0.5, id.style='top',col.legend.cex=1,
     col.label='Ca', family="serif")

sp4$name # 
par(mar=c(2,2,3,2)) # tighter figure margins
plot(sp4, name='name', color='name', col.palette=RColorBrewer::brewer.pal(9, 'Set1'), col.label='Nomes do Horizontes', 
     cex.names=0.5)
###############
### Boxplot ###
# Aqui usaremos o conjunto sp1
sp1$name1 <- generalize.hz(sp1$name, 
                           new=c('A','AB', 'BA','B','BC', 'C', 'E', 'AE', 'O', 'H', 'R', '2C', '3C', '3B', '3A'), 
                           pat=c('^A','^AB','^BA','^B','^BC','^C', '^E', '^AE', '^O', '^H', '^R', '^2C', '^3C','^3B', '^3A' ))

# compute horizon mid-points 
sp1$mid <- with(horizons(sp1), (top+ bottom)/2)
# sort horizon designation by group-wise median values 
hz.designation.by.median.depths <- names(sort(tapply(sp1$mid, sp1$name1, median)))
# plot the distribution of horizon mid-points by designation 
bwplot(mid ~ factor(name, levels=hz.designation.by.median.depths),
       data=horizons(sp1),       
       ylim=c(200, 0), ylab='Profundidade do ponto m√©dio do horizonte (cm)',       
       scales=list(y=list(tick.number=10)),       
       panel= function ( ... ) {
         panel.abline(h=seq(0, 180, by=10), v=1:length(hz.designation.by.median.depths), col=grey(0.8), lty=3)    
         panel.bwplot( ... ) })
bwplot(prop~ factor(name1, levels=hz.designation.by.median.depths),
       data=horizons(sp1),       
       ylab='Profundidade',       
       scales=list(y=list(tick.number=10)),       
       panel= function ( ... ) {  
         panel.abline(h=seq(0, 600, by=50), v=1:length(hz.designation.by.median.depths), col=grey(0.8), lty=3)  
         panel.bwplot( ... ) })
```

### Se voc√™ chegou at√© aqui muito bem !!!! üëèüëèüëè

# Refer√™ncias
